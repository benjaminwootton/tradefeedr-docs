= Execution Stats

== Introduction

The `v1/fx/algo/execution-stats` endpoint is designed to study general algo execution patterns, anything from child fill quality and market impact of individual child fills to user specific events.  For example, the endpoint can  be used to summarize spread paid and market impact generated by different liquidity providers when they place orders on different ECNs (venue analysis).

It allows you to query across the entire algo execution history (from parent level information to child orders/events). 
The query returns a table with the metrics (fields) selected by you as columns. The rows are defined by `groupby` statements. 


== API Specification
The API endpoint requires a JSON object representing query logic similar to SQL and containing the following fields:

* `groupby` - which fields the results will be aggregated by
* `select`  - which fields should be returned in the end result. For example `SpreadPnLPM`. The full list of possible values is given below 
* `filter`  - how the underlying data should be filtered
* `child_filter` - how the child orders should be filtered
* `parent_filter` - how the parent orders should be filtered



== Examples 
**Note**: For display purposes we have limited the number of rows to 5 and and columns to 10.    

=== Only `LP` in `groupby`
---

Refer to xref:api_algo/api_algo.adoc[Algo API] page for page for details on aggregation logic.

**Note:** Aggregation is different depending on `select` and `groupby` fields

In the example below we groupby `LP`, numerical fields such as `Price`,`Mid0` return `None` as we aggregate across `Symbol` and `Side`. The aggregation of these results do not return a meaningful result.


====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats.py[]
----
====

==== Results
---
image::api_algo/execution_stats/api_algo_execution_stats_ex1.png["api_algo_execution_stats_ex1.png"]


====  `Symbol` and `Side` in `groupby`
---
Refer to xref:api_algo/api_algo.adoc[Algo API] page for page for details on aggregation logic.

**Note:** In this case as we are applying a `groupby` by `Symbol` and `Side`.`Price` and `Mid0` are specified in `select`. They are returned as weighted average across `groupby` categories with `TradeQuantityUSD` being the weights. In this case the results are not `None` as we are not aggregating across different `Symbol` and `Side` values.

`ExecVenue` and `LP` are still returned as `None` because there is not consistent way to aggregate symbolic variable such as `ExecVenue` or `LP` across e.g all EURUSD trades 

====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex2.py[]
----
====

==== Results
---
image::api_algo/execution_stats/api_algo_execution_stats_ex2.png["api_algo_execution_stats_ex2.png"]

=== `TradeID` present in `groupby`
---
Refer to xref:api_algo/api_algo.adoc[Algo API] page for page for details on aggregation logic.

**Note:** In this case we are grouping by `TradeID` this is a unique event identifier. Therefore, the presence of `TradeID` changes the default behaviours. 

String fields such as `Symbol`, `ExecVenue` and `Price` all have values instead of `None` as they are unique.

====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex3.py[]
----
====

==== Results
---
image::api_algo/execution_stats/api_algo_execution_stats_ex3.png["api_algo_execution_stats_ex3.png"]

=== Venue Analysis
---
==== Venue Analysis example 1 
---
Venue analysis is a popular way to assess the quality of child execution. 
Typically aggressive (or taker) fills are expected to pay spread (variable `SpreadPnLPM` in the below) and 
passive (maker) fills are expected to receive spread (pay negative spread). 
It is also important what the market does after fill. 

`DecayPM1s` measures side-adjusted move in $/m. Positive number means that that market mid goes up after buy fill and down after sell fill.

====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex4.py[]
----
====

==== Results
---
image::api_algo/execution_stats/api_algo_execution_stats_ex4.png["api_algo_execution_stats_ex4.png"]

==== Figure
---

====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex4_fig.py[]
----
====

++++
<div id='chart1'></div>
<script>
	d3.csv("../_attachments/api_algo/execution_stats/api_algo_execution_stats_ex4.csv").then((data) => {
    var selected = 'LP1';
    const res = data.filter(({
    LP
    }) => selected.includes(LP));
        
		var trace1 = [{
				x: res.map((column) => column.ExecVenue),
				y: res.map((column) => column.SpreadPnLPM),
				type: 'bar',
				name: 'SpreadPnLPM',
                transforms: [{
                            type: 'sort',
                            target: 'y',
                            order: 'ascending'
                            }]                
		}]

		var char_data = trace1; 
		
		var layout = {
					title: 'LP1 ExecVenue Analysis',
					showlegend: true,
					width: 750,
					height: 500,
                    xaxis: {
                        title: {
                          text: 'ExecVenue'
                          }
                        },
                   
                  yaxis: {
                    title: {
                      text: 'SpreadPnLPM'
                      },
                    range: [22, 30]  
                    }                    
					};                    


		var output_div = document.getElementById('chart1')
		Plotly.newPlot(output_div, char_data, layout, { margin: { t: 0 } },{displayModeBar: false})
		
	})
	
</script>
++++


==== Venue Analysis example 2:Using child_filter and parent_filter
---
Same as the above example however, we are showcasing the `child_filter` and `parent_filter` options.

We obtain the same results as above using a filter on the child orders and a filter on the parent orders.

* The parent_filter is applied to the parent orders, in this example we filter for a date range and parent orders that traded EURUSD or USDJPY.
* The child_filter is applied to return only child orders that traded between 12pm and 2pm.


====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex5.py[]
----
====

==== Results
---
image::api_algo/execution_stats/api_algo_execution_stats_ex5.png["api_algo_execution_stats_ex5.png"]

==== Figure
---

====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex4_fig.py[]
----
====

++++
<div id='chart2'></div>
<script>
	d3.csv("../_attachments/api_algo/execution_stats/api_algo_execution_stats_ex4.csv").then((data) => {
    var selected = 'LP1';
    const res = data.filter(({
    LP
    }) => selected.includes(LP));
        
		var trace1 = [{
				x: res.map((column) => column.ExecVenue),
				y: res.map((column) => column.SpreadPnLPM),
				type: 'bar',
				name: 'SpreadPnLPM',
                transforms: [{
                            type: 'sort',
                            target: 'y',
                            order: 'ascending'
                            }]                
		}]

		var char_data = trace1; 
		
		var layout = {
					title: 'LP1 ExecVenue Analysis',
					showlegend: true,
					width: 750,
					height: 500,
                    xaxis: {
                        title: {
                          text: 'ExecVenue'
                          }
                        },
                   
                  yaxis: {
                    title: {
                      text: 'SpreadPnLPM'
                      }
                    }                    
					};                    


		var output_div = document.getElementById('chart2')
		Plotly.newPlot(output_div, char_data, layout, { margin: { t: 0 } },{displayModeBar: false})
		
	})
	
</script>
++++

==== Venue Analysis example 3: Large trades
---
As with the above example, we are using the child and parent filters.
In this example we add a filter for EURUSD trades, for LP1 and trade size greater than $50M.

====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex6.py[]
----
====

==== Results
---
image::api_algo/execution_stats/api_algo_execution_stats_ex6.png["api_algo_execution_stats_ex6.png"]

==== Figure
---

====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex6_fig.py[]
----
====

++++
<div id='chart3'></div>
<script>
	d3.csv("../_attachments/api_algo/execution_stats/api_algo_execution_stats_ex6.csv").then((data) => {
    var selected = 'LP1';
    const res = data.filter(({
    LP
    }) => selected.includes(LP));
        
		var trace1 = [{
				x: res.map((column) => column.ExecVenue),
				y: res.map((column) => column.DecayPM1s),
				type: 'bar',
				name: 'SpreadPnLPM',
                transforms: [{
                            type: 'sort',
                            target: 'y',
                            order: 'ascending'
                            }]                   
		}]

		var char_data = trace1; 
		
		var layout = {
					title: 'LP1 DecayPM1s ExecVenue Analysis for Trades greater than $50m',
					showlegend: true,
					width: 750,
					height: 500,
                    xaxis: {
                        title: {
                          text: 'ExecVenue'
                          }
                        },
                   
                  yaxis: {
                    title: {
                      text: 'DecayPM1s'
                      }
                    }                    
					};


		var output_div = document.getElementById('chart3')
		Plotly.newPlot(output_div, char_data, layout, { margin: { t: 0 } },{displayModeBar: false})
		
	})
	
</script>
++++


===  User defined field names
---
You can apply aggregation functions (such as `sum`, `avg`, `dev`,`max`,`min`,`count`,`first` and `last`, aggregation functions documented towards the end of this document) to the same variable (`TradeQuantityUSD`). 
In this case you can name the resulting column as you wish.

====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex7.py[]
----
====

==== Results
---
image::api_algo/execution_stats/api_algo_execution_stats_ex7.png["api_algo_execution_stats_ex7.png"]


=== Histogram examples
---

==== Histogram (Buckets) example 1
---
Group modification function `hist` (stands for histogram buckets) splits the incoming variable range (`SpreadPnLPM` in the below example) into a number of buckets of the same size.  Variables in the `select` operator are aggregated within those buckets. 

**Note**: The resulting column created by applying `hist` in the groupby, returns the middle value of the bucket.

====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex9.py[]
----
====

==== Results
---
image::api_algo/execution_stats/api_algo_execution_stats_ex9.png["api_algo_execution_stats_ex9.png",400,100]

==== Figure
---

====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex9_fig.py[]
----
====

++++
<div id='chart5'></div>
<script>
	d3.csv("../_attachments/api_algo/execution_stats/raw/api_algo_execution_stats_ex9.csv").then((data) => {

		var trace1 = [{
				x: data.map((column) => column.SpreadPnLPM),
				y: data.map((column) => column.Count),
				type: 'bar',
				name: 'Count'
		}]

		var char_data = trace1; 
		
		var layout = {
					title: 'SpreadPnLPM Distribution',
					showlegend: true,
					width: 750,
					height: 500,
                    xaxis: {
                        title: {
                          text: 'SpreadPnLPM'
                          }
                        },
                   
                  yaxis: {
                    title: {
                      text: 'Count'
                      }
                    }                    
					};


		var output_div = document.getElementById('chart5')
		Plotly.newPlot(output_div, char_data, layout, { margin: { t: 0 } },{displayModeBar: false})
		
	})
	
</script>
++++


==== Histogram (Buckets) example 2
---
`hist_range` function returns the range of the bucket

====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex11.py[]
----
====

==== Results
---
image::api_algo/execution_stats/api_algo_execution_stats_ex11.png["api_algo_execution_stats_ex11.png",550,100]


==== Histogram (Buckets) example 3
---
`hist_index` function returns the index of the bucket

====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex12.py[]
----
====

==== Results
---
image::api_algo/execution_stats/api_algo_execution_stats_ex12.png["api_algo_execution_stats_ex12.png",450,100]


==== Figure
---

====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex12_fig.py[]
----
====

++++
<div id='chart6'></div>
<script>
	d3.csv("../_attachments/api_algo/execution_stats/raw/api_algo_execution_stats_ex12.csv").then((data) => {

		var trace1 = [{
				x: data.map((column) => column.TradeQuantityUSD),
				y: data.map((column) => column.Count),
				type: 'bar',
				name: 'Count'
		}]

		var char_data = trace1; 
		
		var layout = {
					title: 'Histogram (Buckets) example 4: hist_index ',
					showlegend: true,
					width: 750,
					height: 500,
                    xaxis: {
                        title: {
                          text: 'TradeQuantityUSD Buckets'
                          }
                        },
                   
                  yaxis: {
                    title: {
                      text: 'Count'
                      }
                    }
                                        
					};


		var output_div = document.getElementById('chart6')
		Plotly.newPlot(output_div, char_data, layout, { margin: { t: 0 } },{displayModeBar: false})
		
	})
	
</script>
++++


=== LP masking
---

====  Two categories (`eqx` function) 
---
`eqx` returns the variable if the input is equal to this variable and  `Other` if the equality is not satistfied. 

This can be utilised by algo user to performance broker review style analysis. The analysis can be provided to the broker to show their own stats together with aggregated stats of all other brokers. This way algo user can hide proprietary details but provide broker with some information.

This can also be used by the LP to do internal analysis of one thier account versus everything else. 

====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex13.py[]
----
====

==== Results
---
image::api_algo/execution_stats/api_algo_execution_stats_ex13.png["api_algo_execution_stats_ex13.png",450,100]



==== Two categories (`eq` masking) 
---
`eq` returns `True` or `False`. This can be used for broker review analysis as per above. This can also be used to group the dataset into two categories.

====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex14.py[]
----
====

==== Results
---
image::api_algo/execution_stats/api_algo_execution_stats_ex14.png["api_algo_execution_stats_ex14.png",450,100]

=== Percentile 
---
`percentile` returns the x percentile of the specified column.

We return the value corresponding to the 25th, 50th, 75th,90th and 100th percentile of `SpreadPnLPM`.
You can query various percentiles in the `select` parameter and analyse distribution of the chosen metric.

====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex15.py[]
----
====

==== Results
---
image::api_algo/execution_stats/api_algo_execution_stats_ex15.png["api_algo_execution_stats_ex15.png"]

==== Figure
---

====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex15_fig.py[]
----
====

++++
<div id='chart7'></div>
<script>
	d3.csv("../_attachments/api_algo/execution_stats/api_algo_execution_stats_ex15.csv").then((data) => {

		var trace1 = [{
				x: data.map((column) => column.LP),
				y: data.map((column) => column.SpreadPnLPM_Pct25),
				type: 'bar',
				name: 'SpreadPnLPM_Pct25'
		}]
		var trace2 = [{
				x: data.map((column) => column.LP),
				y: data.map((column) => column.SpreadPnLPM_Pct50),
				type: 'bar',
				name: 'SpreadPnLPM_Pct50'
		}]
        
		var trace3 = [{
				x: data.map((column) => column.LP),
				y: data.map((column) => column.SpreadPnLPM_Pct75),
				type: 'bar',
				name: 'SpreadPnLPM_Pct75'
		}]
        
		var trace4 = [{
				x: data.map((column) => column.LP),
				y: data.map((column) => column.SpreadPnLPM_Pct90),
				type: 'bar',
				name: 'SpreadPnLPM_Pct90'
		}]
        
		var trace5 = [{
				x: data.map((column) => column.LP),
				y: data.map((column) => column.SpreadPnLPM_Pct100),
				type: 'bar',
				name: 'SpreadPnLPM_Pct100'
		}]


		var char_data = trace1.concat(trace2, trace3, trace4, trace5); 
		
		var layout = {
					title: 'Percentile function applied to SpreadPnLPM',
					showlegend: true,
					width: 750,
					height: 500,
                    xaxis: {
                        title: {
                          text: 'LP'
                          }
                        },
                   
                  yaxis: {
                    title: {
                      text: 'SpreadPnLPM'
                      }
                    }                    
					};


		var output_div = document.getElementById('chart7')
		Plotly.newPlot(output_div, char_data, layout, { margin: { t: 0 } },{displayModeBar: false})
		
	})
	
</script>
++++


=== Rank Percentile 
---
The `rank_percentile` function transforms the target column into a value in the range of [0;100].

This is applied in the `filter` option. The algo user can use this function to apply an outlier filtering. 
`DecayPM1s` results are filtered to only select values which fall within the 10th-90th percentile range.

====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex16.py[]
----
====

==== Results
---
image::api_algo/execution_stats/api_algo_execution_stats_ex16.png["api_algo_execution_stats_ex16.png",350,100]


=== Stale market data (minus transformation)
---
Applying the `minus` transformation to compute the difference between `TradeTime` and `ArrivalTime`, this measures how stale the data is.
This example filters the data to only include results where the difference between `TradeTime` and `ArrivalTime` is less than 500ns.
Use `diff_millis` instead of `minus` to get time difference in ms.

====
[source,python]
----
include::example$api_algo/execution_stats/api_algo_execution_stats_ex17.py[]
----
====

==== Results
---
image::api_algo/execution_stats/api_algo_execution_stats_ex17.png["api_algo_execution_stats_ex17.png",350,100]]


== Field Definitions

Refer to xref:analytics_algo.adoc[Analytics Algo] page for details and formula.


[%header,format=csv]
|===
include::example$api_algo/execution_stats/field-definitions_execution_stats.csv[]
|===

=== Aggreggation Functions (for `select` if `groupby` is present)
---

[%header,format=csv]
|===
include::example$api_algo/execution_stats/field-definitions_execution_stats_agg_functions.csv[]
|===

=== Modification Functions (for `filter` and `groupby` )
---

[%header,format=csv]
|===
include::example$api_algo/execution_stats/field-definitions_execution_stats_modif_function.csv[]
|===