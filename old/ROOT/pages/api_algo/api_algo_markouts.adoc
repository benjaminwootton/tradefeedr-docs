= Markouts

== Introduction
The `v1/fx/algo/markouts` endpoint returns the markout curves information in a number of tables.

These tables include: 

* `Markout` - Markout Curves starting at SpreadPNL at time zero. Those curve represent the PnL of counterparty
* `MarkoutsAtZero`  - Markout Curves starting at 0 at time 0. Those curves represent price impact curves and do not include Spread Paid
* `MarkoutsAtZeroAverage` - Average (as opposed to weighted average) version of MarkoutsAtZero
* `Volatilities` - Standard deviation of each markout point for confidence intervals


Mark-out Curves represent market dynamics before and after each trading event (fill, reject or order placement). This market dynamics is typically aggregated across different categories such as `Symbol` `LP`, `ExecVenue` and `ParentOrderID` but it is possible to extract markout curves for each trading event as well.

== API Specification
The API endpoint requires a JSON object representing query logic similiar to SQL and containing the following fields:

* `groupby` - what fields to aggregate markouts by
* `filter`  - how the underlying data should be filtered
* `child_filter` - how the child orders should be filtered
* `parent_filter` - how the parent orders should be filtered


== Markout Definitions

Mark-out Curves represent PnL (in dollar/m traded) earned by the counterparty of your trades. Market Impact Curves represent your PnL from inception (using mid and ignoring the spread). Tradefeedr supports both.    

Mark-out curves are calculated for each trade and aggregated across by `LP`, `Account`, `Symbol` traded etc. The aggregation weights for are proportional to Trade sizes.  Direction is adjusted for Side (buy or sell).

Mark-out curve at time 0 represents Spread paid on a trade (in dollar/m) - so called Inception PnL for market maker.
Mark-out curve at 30s represents PnL left for the market maker 30s after the trade is done. The PnL is marked-to-market using Tradefeedr mid.              

For example, if spread paid is 25 dollar/m and mid-price move is 10 dollar/m against LP then the mark-out curve will show 15 dollar/m. 

Effectively, mark-out curve at time X can be thought as an approximation of market maker PnL if the trade is covered at time X at mid.
Typically (but not always) mark-out curves are downward sloping meaning that less spread PnL is left LP as time goes by. 

Downward sloping mark-out curve means that your trades have positive momentum, spot goes UP after BUY trade and DOWN after SELL. 

We also present dynamics before the trade time.  It has the same interpretation.
 Downward sloping curve from -10s to 0 means spot was going UP before BUY trade happened (DOWN before sell trade happened). 

== Examples 
**Note**: For display purposes we have limited the number of rows to 5 and and columns to 10.

=== Markouts by ParentOrderID
---

In this example we have queried the API for a single ParentOrderID.
Using this data we have created a markouts plot with volatility bands.
Where the `MarkoutType` equal to `Volatilities` is being used to construct the confidence intervals.


====
[source,python]
----
include::example$api_algo/markouts/api_algo_markouts.py[]
----
====

==== Results
---
image::api_algo/markouts/api_algo_markouts_ex1.png["api_algo_markouts_ex1.png"]

==== Figure
---

====
[source,python]
----
include::example$api_algo/markouts/api_algo_markouts_ex1_fig.py[]
----
====

++++
<div id='chart1'></div>
<script>
	d3.csv("../_attachments/api_algo/markouts/api_algo_markouts_ex1_mod_vol_bands.csv").then((data) => {
		var trace1 = [{
				x: data.map((row) => row.Time),
				y: data.map((row) => row.Markouts),
				type: 'line',
				name: 'Markouts'
                
		}]
		
		var trace2 = [{
				x: data.map((row) => row.Time),
				y: data.map((row) => row.VolBand1),
				type: 'line',
                fill: 'tonexty',
				name: 'Confidence Interval 2'
		}]
		
		var trace3 = [{
				x: data.map((row) => row.Time),
				y: data.map((row) => row.VolBand2),
				type: 'line',
                fill: 'tonexty',
				name: 'Confidence Interval 1'
		}]
		

		var char_data = trace1.concat(trace2,trace3); 
		
		var layout = {
					title: 'Market Data and Execution Data For POID: 20180921-A07',
					showlegend: true,
					width: 750,
					height: 500,
                    xaxis: {
                        title: {
                          text: 'Time'
                          }
                        },
                   
                  yaxis: {
                    title: {
                      text: 'Markouts'
                      }
                    }                    
					};


		var output_div = document.getElementById('chart1')
		Plotly.newPlot(output_div, char_data, layout, { margin: { t: 0 } },{displayModeBar: false})
	})



</script>
++++

=== Using the child and parent filters
---
We obtain the same results as above using a filter on the child orders and a filter on the parent orders.

* The `parent_filter` is applied to the parent orders, in this case we filter the parent orders such that the ParentOrderID equal to 20180921-A00.
* The `child_filter` is applied to return only markouts on the child orders. 

For markouts to have a meaningful result we must look at the child orders only. As child rows reflect the actions of AlgoVendor, the institution responsible for algo execution. This includes child fills, order placements and rejects.


====
[source,python]
----
include::example$api_algo/markouts/api_algo_markouts_ex2.py[]
----
====
==== Results
---
image::api_algo/markouts/api_algo_markouts_ex2.png["api_algo_markouts_ex2.png"]

==== Figure
---

====
[source,python]
----
include::example$api_algo/markouts/api_algo_markouts_ex2_fig.py[]
----
====

++++
<div id='chart2'></div>
<script>
	d3.csv("../_attachments/api_algo/markouts/api_algo_markouts_ex1_mod.csv").then((data) => {
		var trace1 = [{
				x: data.map((row) => row.Time),
				y: data.map((row) => row.Markouts),
				type: 'line',
				name: 'Markouts'
		}]

		var char_data = trace1; 
		
		var layout = {
					title: 'Markouts Using Child and Parent Filters For POID:20180921-A00',
					showlegend: true,
					width: 750,
					height: 500,
                    xaxis: {
                        title: {
                          text: 'Time'
                          }
                        },
                   
                  yaxis: {
                    title: {
                      text: 'Markouts'
                      }
                    }                    
					};                    



		var output_div = document.getElementById('chart2')
		Plotly.newPlot(output_div, char_data, layout, { margin: { t: 0 } },{displayModeBar: false})
	})



</script>
++++

=== Venue Analysis
---
In this example we use the `child_filter` to filter for child orders, that have traded more than $10M and to specify the type of markouts we want to view.

The `parent_filter` is used to filter for large trades greater than $100M, for only EURUSD trades and which `LP` we want to review the markout of.

====
[source,python]
----
include::example$api_algo/markouts/api_algo_markouts_ex3.py[]
----
====

==== Results
---
image::api_algo/markouts/api_algo_markouts_ex3.png["api_algo_markouts_ex3.png"]

==== Figures
---

====
[source,python]
----
include::example$api_algo/markouts/api_algo_markouts_ex3_fig.py[]
----
====


++++
<div id='chart3'></div>
<script>
	d3.csv("../_attachments/api_algo/markouts/api_algo_markouts_ex3_mod_atzero.csv").then((data) => {
		var trace1 = [{
				x: data.map((row) => row.Time),
				y: data.map((row) => row.ExecV1),
				type: 'line',
				name: 'ExecV1'
		}]

		var trace2 = [{
				x: data.map((row) => row.Time),
				y: data.map((row) => row.ExecV2),
				type: 'line',
				name: 'ExecV2'
		}]
		
		
		
		var char_data = trace1.concat(trace2); 
		
		var layout = {
					title: 'MarkoutsAtZero by ExecVenue For POID:20180903-A03',
					showlegend: true,
					width: 750,
					height: 500,
					};


		var output_div = document.getElementById('chart3')
		Plotly.newPlot(output_div, char_data, layout, { margin: { t: 0 } },{displayModeBar: false})
	})
</script>
++++

++++
<div id='chart4'></div>
<script>
	d3.csv("../_attachments/api_algo/markouts/api_algo_markouts_ex3_mod_atzeroavg.csv").then((data) => {
		var trace1 = [{
				x: data.map((row) => row.Time),
				y: data.map((row) => row.ExecV1),
				type: 'line',
				name: 'ExecV1'
		}]

		var trace2 = [{
				x: data.map((row) => row.Time),
				y: data.map((row) => row.ExecV2),
				type: 'line',
				name: 'ExecV2'
		}]
		
		var char_data = trace1.concat(trace2); 
		
		var layout = {
					title: 'MarkoutsAtZeroAverage by ExecVenue For POID:20180903-A03',
					showlegend: true,
					width: 750,
					height: 500,
					};

		var output_div = document.getElementById('chart4')
		Plotly.newPlot(output_div, char_data, layout, { margin: { t: 0 } },{displayModeBar: false})
	})

</script>
++++

== Field Definitions

Refer to xref:analytics_algo.adoc[Analytics Algo] page for details and formula.

[%header,format=csv]
|===
include::example$api_algo/markouts/field-definitions_markouts.csv[]
|===