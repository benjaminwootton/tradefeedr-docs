# Execution Stats

## Introduction

The `v1/fx/algo/execution-stats` endpoint is designed to study general algo execution patterns, anything from child fill quality and market impact of individual child fills to user specific events.  For example, the endpoint can  be used to summarize spread paid and market impact generated by different liquidity providers when they place orders on different ECNs (venue analysis).

It allows you to query across the entire algo execution history (from parent level information to child orders/events). 
The query returns a table with the metrics (fields) selected by you as columns. The rows are defined by `groupby` statements. 

## API Specification
The API endpoint requires a JSON object representing query logic similar to SQL and containing the following fields:

- `groupby` - which fields the results will be aggregated by
- `select`  - which fields should be returned in the end result. For example `SpreadPnLPM`. The full list of possible values is given below
- `filter`  - how the underlying data should be filtered
- `child_filter` - how the child orders should be filtered
- `parent_filter` - how the parent orders should be filtered

## Examples 
**Note**: For display purposes we have limited the number of rows to 5 and and columns to 10.    

### Only `LP` in `groupby`

Refer to [Algo API](algo/README.md) page for page for details on aggregation logic.

**Note:** Aggregation is different depending on `select` and `groupby` fields

In the example below we groupby `LP`, numerical fields such as `Price`,`Mid0` return `None` as we aggregate across `Symbol` and `Side`. The aggregation of these results do not return a meaningful result.

```python
```
## tradefeedr library
from tradefeedr_public_content.v1.generic.tradefeedr_api import TradefeedrApi

## need pandas to translate JSON results from API
import pandas as pd

## create API object
tf_api_object = TradefeedrApi(demo=True)

## options
options = {
    "groupby": ["LP"],
    "select": [
        "TradeQuantityUSD", # sum
        "SpreadPnLPM",      # TradeQuantityUSD-weighted average
        "DecayPM1s",        # TradeQuantityUSD-weighted average
        "Symbol",           # cannot aggregate - returns None
        "ExecVenue",        # cannot aggregate - returns None
        "Mid0",             # cannot aggregate - returns None
        "Price",            # cannot aggregate - returns None
        {"function": "sum", "var": "TradeQuantityUSD", "name": "TotalVolume"},      # explicit aggregation function
        {"function": "avg", "var": "Price", "name": "AvgPrice"},                    # explicit aggregation function
    ],
    "filter": [
        {"function": "within", "var": "Date", "pars": ["2014-01-01", "2021-11-30"]},
        {"function": "within", "var": "TradeTime", "transform": "time", "pars": ["12:00:00", "14:00:00"]},
        {"function": "in", "var": "Symbol", "pars": ["EURUSD", "USDJPY"]},
        {"function": "eq", "var": "ParentChild", "par": "Child"},
    ],
}

# this is api end-point which returns execution stats
endpoint = "v1/fx/algo/execution-stats"

## call the API
response = tf_api_object.query_api(endpoint, options)

## translate API result into pandas dataframe
data_frame = pd.DataFrame(response["result"])
 # data_frame = data_frame.set_index("LP")
data_frame
```
```
#### Results

![api_algo_execution_stats_ex1.png](assets/images/api_algo/execution_stats/api_algo_execution_stats_ex1.png)

####  `Symbol` and `Side` in `groupby`

Refer to [Algo API](algo/README.md) page for page for details on aggregation logic.

**Note:** In this case as we are applying a `groupby` by `Symbol` and `Side`.`Price` and `Mid0` are specified in `select`. They are returned as weighted average across `groupby` categories with `TradeQuantityUSD` being the weights. In this case the results are not `None` as we are not aggregating across different `Symbol` and `Side` values.

`ExecVenue` and `LP` are still returned as `None` because there is not consistent way to aggregate symbolic variable such as `ExecVenue` or `LP` across e.g all EURUSD trades 

```python
```
## tradefeedr library
from tradefeedr_public_content.v1.generic.tradefeedr_api import TradefeedrApi

## need pandas to translate JSON results from API
import pandas as pd

## create API object
tf_api_object = TradefeedrApi(demo=True)

## options
options = {
    "groupby": [
        "Symbol",
        "Side"
    ],
    "select": [
        "TradeQuantityUSD",
        "SpreadPnLPM",
        "DecayPM1s",
        "ExecVenue",
        "LP",
        "Mid0",
        "Price",
        {"function": "sum", "var": "TradeQuantityUSD", "name": "TotalVolume"},
        {"function": "avg", "var": "Price", "name": "AvgPrice"},
    ],
    "filter": [
        {"function": "within", "var": "Date", "pars": ["2014-01-01", "2021-11-30"]},
        {"function": "within", "var": "TradeTime", "transform": "time", "pars": ["12:00:00", "14:00:00"]},
        {"function": "in", "var": "Symbol", "pars": ["EURUSD", "USDJPY"]}
    ],
}

# this is api end-point which returns execution stats
endpoint = "v1/fx/algo/execution-stats"

## call the API
response = tf_api_object.query_api(endpoint, options)

## translate API result into pandas dataframe
data_frame = pd.DataFrame(response["result"])
# data_frame = data_frame.set_index("Symbol")
data_frame
```
```
#### Results

![api_algo_execution_stats_ex2.png](assets/images/api_algo/execution_stats/api_algo_execution_stats_ex2.png)

### `TradeID` present in `groupby`

Refer to [Algo API](algo/README.md) page for page for details on aggregation logic.

**Note:** In this case we are grouping by `TradeID` this is a unique event identifier. Therefore, the presence of `TradeID` changes the default behaviours. 

String fields such as `Symbol`, `ExecVenue` and `Price` all have values instead of `None` as they are unique.

```python
```
## tradefeedr library
from tradefeedr_public_content.v1.generic.tradefeedr_api import TradefeedrApi

## need pandas to translate JSON results from API
import pandas as pd

## create API object
tf_api_object = TradefeedrApi(demo=True)

## options
options = {
    "groupby": [
        "TradeID"
    ],
    "select": [
        "TradeQuantityUSD",
        "SpreadPnLPM",
        "DecayPM1s",
        "Symbol",
        "LP",
        "Side",
        "ExecVenue",
        "Mid0",
        "Price",
        {"function": "sum", "var": "TradeQuantityUSD", "name": "TotalVolume"},
        {"function": "avg", "var": "Price", "name": "AvgPrice"}
    ],
    "filter": [
        {"function": "within", "var": "Date", "pars": ["2014-01-01", "2021-11-30"]},
        {"function": "within", "var": "TradeTime", "transform": "time", "pars": ["12:00:00", "14:00:00"]},
        {"function": "in", "var": "Symbol", "pars": ["EURUSD", "USDJPY"]},
        {"function": "eq", "var": "ParentChild", "par": "Child"}
    ],
}

# this is api end-point which returns execution stats
endpoint = "v1/fx/algo/execution-stats"

## call the API
response = tf_api_object.query_api(endpoint, options)

## translate API result into pandas dataframe
data_frame = pd.DataFrame(response["result"])
# data_frame = data_frame.set_index("TradeID")
data_frame
```
```
#### Results

![api_algo_execution_stats_ex3.png](assets/images/api_algo/execution_stats/api_algo_execution_stats_ex3.png)

### Venue Analysis

#### Venue Analysis example 1 

Venue analysis is a popular way to assess the quality of child execution. 
Typically aggressive (or taker) fills are expected to pay spread (variable `SpreadPnLPM` in the below) and 
passive (maker) fills are expected to receive spread (pay negative spread). 
It is also important what the market does after fill. 

`DecayPM1s` measures side-adjusted move in $/m. Positive number means that that market mid goes up after buy fill and down after sell fill.

```python
```
## tradefeedr library
from tradefeedr_public_content.v1.generic.tradefeedr_api import TradefeedrApi

## need pandas to translate JSON results from API
import pandas as pd

## create API object
tf_api_object = TradefeedrApi(demo=True)

## options
options = {
    "groupby": [
        "AlgoVendor",  # this is the institution responsible for the overall execution of algo
        "LP",          # this is the actual LP for the child order -  can be same as AlgoVendor
        "ExecVenue",   # venue where trading takes place -  can be "CboeFX", "EuronextFX"
        "OrderType",   # this should be "Market" or "Limit" or "Aggressive" or "Passive"
        "LiqPool"      # this can be specific liquidity pool like "no last look"
    ],
    "select": [
        "TradeQuantityUSD",
        "SpreadPnLPM", # spread paid in $/m, see definition in the end of the doc
        "DecayPM1s",
        "DecayPM5s"
    ],
    "filter": [
        {"function": "eq", "var": "ParentChild", "par": "Child"},
        {"function": "within", "var": "TradeTime", "transform": "time", "pars": ["12:00:00", "14:00:00"]},
        {"function": "within", "var": "Date", "pars": ["2014-01-01", "2021-11-30"]},
        {"function": "in", "var": "Symbol", "pars": ["EURUSD", "USDJPY"]}
    ]
}

# this is api end-point which returns execution stats
endpoint = "v1/fx/algo/execution-stats"

## call the API
response = tf_api_object.query_api(endpoint, options)

## translate API result into pandas dataframe
data_frame = pd.DataFrame(response["result"])
# data_frame = data_frame.set_index("AlgoVendor")
data_frame
```
```
#### Results

![api_algo_execution_stats_ex4.png](assets/images/api_algo/execution_stats/api_algo_execution_stats_ex4.png)

#### Figure

```python
```
# import plotly libary
import plotly.express as px

# Modify dataframe
data_frame = data_frame[data_frame.LP=="LP1"].set_index("ExecVenue")

# Plot figure
fig = px.bar(data_frame["SpreadPnLPM"], title="LP1 ExecVenue Analysis")
fig.update_layout(xaxis={"categoryorder":"total ascending"})
fig.show()
```
```
#### Venue Analysis example 2:Using child_filter and parent_filter

Same as the above example however, we are showcasing the `child_filter` and `parent_filter` options.

We obtain the same results as above using a filter on the child orders and a filter on the parent orders.

- The parent_filter is applied to the parent orders, in this example we filter for a date range and parent orders that traded EURUSD or USDJPY.
- The child_filter is applied to return only child orders that traded between 12pm and 2pm.

```python
```
## tradefeedr library
from tradefeedr_public_content.v1.generic.tradefeedr_api import TradefeedrApi

## need pandas to translate JSON results from API
import pandas as pd

## create API object
tf_api_object = TradefeedrApi(demo=True)

## options
options = {
    "groupby": [
        "AlgoVendor",  # this is the institution responsible for the overall execution of algo
        "LP",          # this is the actual LP for the child order -  can be same as AlgoVendor
        "ExecVenue",   # venue where trading takes place -  can be "CboeFX", "EuronextFX"
        "OrderType",   # this should be "Market" or "Limit" or "Aggressive" or "Passive"
        "LiqPool"     # this can be specific liquidity pool like "no last look"
    ],
    "select": [
        "TradeQuantityUSD",
        "SpreadPnLPM", # spread paid in $/m, see definition in the end of the doc
        "DecayPM1s",
        "DecayPM5s"
    ],
    "child_filter": [
        {"function": "eq", "var": "ParentChild", "par": "Child"},
        {"function": "within", "var": "TradeTime", "transform": "time", "pars": ["12:00:00", "14:00:00"]}
    ],
    "parent_filter":[
        {"function": "within", "var": "Date", "pars": ["2014-01-01", "2021-11-30"]},
        {"function": "in", "var": "Symbol", "pars": ["EURUSD", "USDJPY"]}
    ]
}

# this is api end-point which returns execution stats
endpoint = "v1/fx/algo/execution-stats"

## call the API
response = tf_api_object.query_api(endpoint, options)

## translate API result into pandas dataframe
data_frame = pd.DataFrame(response["result"])
# data_frame = data_frame.set_index("AlgoVendor")
data_frame
```
```
#### Results

![api_algo_execution_stats_ex5.png](assets/images/api_algo/execution_stats/api_algo_execution_stats_ex5.png)

#### Figure

```python
```
# import plotly libary
import plotly.express as px

# Modify dataframe
data_frame = data_frame[data_frame.LP=="LP1"].set_index("ExecVenue")

# Plot figure
fig = px.bar(data_frame["SpreadPnLPM"], title="LP1 ExecVenue Analysis")
fig.update_layout(xaxis={"categoryorder":"total ascending"})
fig.show()
```
```
#### Venue Analysis example 3: Large trades

As with the above example, we are using the child and parent filters.
In this example we add a filter for EURUSD trades, for LP1 and trade size greater than $50M.

```python
```
## tradefeedr library
from tradefeedr_public_content.v1.generic.tradefeedr_api import TradefeedrApi

## need pandas to translate JSON results from API
import pandas as pd

## create API object
tf_api_object = TradefeedrApi(demo=True)

## options
options = {
    "groupby": [
        "AlgoVendor",  # this is the institution responsible for the overall execution of algo
        "LP",          # this is the actual LP for the child order -  can be same as AlgoVendor
        "ExecVenue",   # venue where trading takes place -  can be "CboeFX", "EuronextFX"
        "OrderType",   # this should be "Market" or "Limit" or "Aggressive" or "Passive"
        "LiqPool",     # this can be specific liquidity pool like "no last look"
        "AlgoUrgency"
    ],
    "select": [
        "TradeQuantityUSD",
        "SpreadPnLPM", # spread paid in $/m, see definition in the end of the doc
        "DecayPM1s",
        "DecayPM5s"
    ],
    "child_filter": [
        {"function": "eq", "var": "ParentChild", "par": "Child"}
    ],
    "parent_filter":[
        {"function": "within", "var": "Date", "pars": ["2014-01-01", "2021-11-30"]},
        {"function": "eq", "var": "Symbol", "par": "EURUSD" },
        {"function": "eq", "var": "LP", "par": "LP1"},
        {"function": "gt", "var": "TradeQuantityUSD", "par": 50000000}   # greater than
    ]
}

# this is api end-point which returns execution stats
endpoint = "v1/fx/algo/execution-stats"

## call the API
response = tf_api_object.query_api(endpoint, options)

## translate API result into pandas dataframe
data_frame = pd.DataFrame(response["result"])
# data_frame = data_frame.set_index("AlgoVendor")
data_frame
```
```
#### Results

![api_algo_execution_stats_ex6.png](assets/images/api_algo/execution_stats/api_algo_execution_stats_ex6.png)

#### Figure

```python
```
# import plotly libary
import plotly.express as px

# Modify dataframe
data_frame = data_frame[data_frame.LP=="LP1"].set_index("ExecVenue")

# Plot figure
fig = px.bar(data_frame["DecayPM1s"], barmode="group",
             title="LP1 DecayPM1s ExecVenue Analysis for Trades greater than $50m")
fig.update_layout(xaxis={"categoryorder":"total ascending"})
fig.show()
```
```
###  User defined field names

You can apply aggregation functions (such as `sum`, `avg`, `dev`,`max`,`min`,`count`,`first` and `last`, aggregation functions documented towards the end of this document) to the same variable (`TradeQuantityUSD`). 
In this case you can name the resulting column as you wish.

```python
```
## tradefeedr library
from tradefeedr_public_content.v1.generic.tradefeedr_api import TradefeedrApi

## need pandas to translate JSON results from API
import pandas as pd

## create API object
tf_api_object = TradefeedrApi(demo=True)

## options
options = {
    "groupby": [
        "LP"
    ],
    "select": [
        {"function": "sum", "var": "TradeQuantityUSD", "name": "TotalVolume"},
        {"function": "avg", "var": "TradeQuantityUSD", "name": "AvgTradeSize"},
        {"function": "dev", "var": "TradeQuantityUSD", "name": "DevTotalSize"},
        {"function": "max", "var": "TradeQuantityUSD", "name": "MaxTradeSize"},
        {"function": "min", "var": "TradeQuantityUSD", "name": "MinTradeSize"},
        {"function": "count", "var": "TradeQuantityUSD", "name": "NumberOfTrades"},
        {"function": "first", "var": "TradeTime", "name": "FirstTime"},
        {"function": "last", "var": "TradeTime", "name": "LastTime"}
    ],
    "filter": [
        {"function": "eq", "var": "Symbol", "par": "EURUSD"},
        {"function": "eq", "var": "ParentChild", "par": "Child"}
    ],
}

# this is api end-point which returns execution stats
endpoint = "v1/fx/algo/execution-stats"

## call the API
response = tf_api_object.query_api(endpoint, options)

## translate API result into pandas dataframe
data_frame = pd.DataFrame(response["result"])
# data_frame = data_frame.set_index("AlgoVendor")
data_frame
```
```
#### Results

![api_algo_execution_stats_ex7.png](assets/images/api_algo/execution_stats/api_algo_execution_stats_ex7.png)

### Histogram examples

#### Histogram (Buckets) example 1

Group modification function `hist` (stands for histogram buckets) splits the incoming variable range (`SpreadPnLPM` in the below example) into a number of buckets of the same size.  Variables in the `select` operator are aggregated within those buckets. 

**Note**: The resulting column created by applying `hist` in the groupby, returns the middle value of the bucket.

```python
```
## tradefeedr library
from tradefeedr_public_content.v1.generic.tradefeedr_api import TradefeedrApi

## need pandas to translate JSON results from API
import pandas as pd

## create API object
tf_api_object = TradefeedrApi(demo=True)

## options
options = {
    "groupby": [
        {"function": "hist", "var": "SpreadPnLPM", "par": 10}
    ],
    "select": [
        {"function": "min", "var": "SpreadPnLPM", "name": "MinSpread"},
        {"function": "max", "var": "SpreadPnLPM", "name": "MaxSpread"},
        {"function": "count", "var": "Symbol", "name": "Count"},
        {"function": "min", "var": "TradeQuantityUSD", "name": "TotalVolume"}
    ],
    "filter": [
        {"function": "within", "var": "Date", "pars": ["2014-01-01", "2021-11-30"]},
        {"function": "eq", "var": "ParentChild", "par": "Child"},    # only consider child orders which represent the actual trading
        {"function": "gt", "var": "TradeQuantityUSD", "par": 0}      # ignore order with zero traded quantity
    ],
}

# this is api end-point which returns execution stats
endpoint = "v1/fx/algo/execution-stats"

## call the API
response = tf_api_object.query_api(endpoint, options)

## translate API result into pandas dataframe
data_frame = pd.DataFrame(response["result"])
# data_frame = data_frame.set_index("SpreadPnLPM")
data_frame
```
```
#### Results

![api_algo_execution_stats_ex9.png](assets/images/api_algo/execution_stats/api_algo_execution_stats_ex9.png)

#### Figure

```python
```
# import plotly libary
import plotly.express as px

# Plot figure
fig = px.bar(data_frame, x="SpreadPnLPM", y="Count",
             title="hist function in groupby:SpreadPnLPM" )
fig.show()
```
```
#### Histogram (Buckets) example 2

`hist_range` function returns the range of the bucket

```python
```
## tradefeedr library
from tradefeedr_public_content.v1.generic.tradefeedr_api import TradefeedrApi

## need pandas to translate JSON results from API
import pandas as pd

## create API object
tf_api_object = TradefeedrApi(demo=True)

## options
options = {
    "groupby": [
        {"function": "hist_range", "var": "TradeQuantityUSD", "par": 8}
    ],
    "select": [
        {"function": "min", "var": "Mid0", "name": "MinMid0"},
        {"function": "avg", "var": "Mid0", "name": "AvgMid0"},
        {"function": "max", "var": "Mid0", "name": "MaxMid0"},
        {"function": "min", "var": "TradeQuantityUSD", "name": "TotalVolume"}
    ],
    "filter": [
        {"function": "within", "var": "Date", "pars": ["2014-01-01", "2021-11-30"]},
        {"function": "eq", "var": "ParentChild", "par": "Child"},    # only consider child orders which represent the actual trading
        {"function": "gt", "var": "TradeQuantityUSD", "par": 0},
        {"function": "eq", "var": "Symbol", "par": "EURUSD"}
    ],
}

# this is api end-point which returns execution stats
endpoint = "v1/fx/algo/execution-stats"

## call the API
response = tf_api_object.query_api(endpoint, options)

## translate API result into pandas dataframe
data_frame = pd.DataFrame(response["result"])
# data_frame = data_frame.set_index("TradeQuantityUSD")
data_frame
```
```
#### Results

![api_algo_execution_stats_ex11.png](assets/images/api_algo/execution_stats/api_algo_execution_stats_ex11.png)

#### Histogram (Buckets) example 3

`hist_index` function returns the index of the bucket

```python
```
## tradefeedr library
from tradefeedr_public_content.v1.generic.tradefeedr_api import TradefeedrApi

## need pandas to translate JSON results from API
import pandas as pd

## create API object
tf_api_object = TradefeedrApi(demo=True)

## options
options = {
    "groupby": [
        {"function": "hist_index", "var": "TradeQuantityUSD", "par": 8}
    ],
    "select": [
        {"function": "min", "var": "SpreadPnLPM", "name": "MinSpread"},
        {"function": "max", "var": "SpreadPnLPM", "name": "MaxSpread"},
        {"function": "count", "var": "Symbol", "name": "Count"},
        {"function": "min", "var": "TradeQuantityUSD", "name": "TotalVolume"}
    ],
    "filter": [
        {"function": "within", "var": "Date", "pars": ["2014-01-01", "2021-11-30"]},
        {"function": "eq", "var": "ParentChild", "par": "Child"},    # only consider child orders which represent the actual trading
        {"function": "gt", "var": "TradeQuantityUSD", "par": 0}   # ignore order with zero traded quantity
    ],
}

# this is api end-point which returns execution stats
endpoint = "v1/fx/algo/execution-stats"

## call the API
response = tf_api_object.query_api(endpoint, options)

## translate API result into pandas dataframe
data_frame = pd.DataFrame(response["result"])
# data_frame = data_frame.set_index("TradeQuantityUSD")
data_frame
```
```
#### Results

![api_algo_execution_stats_ex12.png](assets/images/api_algo/execution_stats/api_algo_execution_stats_ex12.png)

#### Figure

```python
```
# import plotly libary
import plotly.express as px

# Plot figure
fig = px.bar(data_frame, x="TradeQuantityUSD", y="Count",
             title="Histogram (Buckets) example 4: hist_index")
fig.show()
```
```
### LP masking

####  Two categories (`eqx` function) 

`eqx` returns the variable if the input is equal to this variable and  `Other` if the equality is not satistfied. 

This can be utilised by algo user to performance broker review style analysis. The analysis can be provided to the broker to show their own stats together with aggregated stats of all other brokers. This way algo user can hide proprietary details but provide broker with some information.

This can also be used by the LP to do internal analysis of one thier account versus everything else. 

```python
```
## tradefeedr library
from tradefeedr_public_content.v1.generic.tradefeedr_api import TradefeedrApi

## need pandas to translate JSON results from API
import pandas as pd

## create API object
tf_api_object = TradefeedrApi(demo=True)

## options
options = {
    "groupby": [
        {"function": "eqx", "var": "LP", "par": "LP1"},
        {"function": "eqx", "var": "Symbol", "par": "EURUSD"}
    ],
    "select": [
        {"function": "min", "var": "SpreadPnLPM", "name": "MinSpread"},
        {"function": "max", "var": "SpreadPnLPM", "name": "MaxSpread"},
        {"function": "count", "var": "Symbol", "name": "Count"},
        {"function": "sum", "var": "TradeQuantityUSD", "name": "TotalVolume"}
    ],
    "filter": [
        {"function": "within", "var": "Date", "pars": ["2014-01-01", "2021-11-30"]}
    ]
}

# this is api end-point which returns execution stats
endpoint = "v1/fx/algo/execution-stats"

## call the API
response = tf_api_object.query_api(endpoint, options)

## translate API result into pandas dataframe
data_frame = pd.DataFrame(response["result"])
# data_frame = data_frame.set_index("LP")
data_frame
```
```
#### Results

![api_algo_execution_stats_ex13.png](assets/images/api_algo/execution_stats/api_algo_execution_stats_ex13.png)

#### Two categories (`eq` masking) 

`eq` returns `True` or `False`. This can be used for broker review analysis as per above. This can also be used to group the dataset into two categories.

```python
```
## tradefeedr library
from tradefeedr_public_content.v1.generic.tradefeedr_api import TradefeedrApi

## need pandas to translate JSON results from API
import pandas as pd

## create API object
tf_api_object = TradefeedrApi(demo=True)

## options
options = {
    "groupby": [
        {"function": "eq", "var": "LP", "par": "LP1"},
        {"function": "eq", "var": "Symbol", "par": "EURUSD"}
    ],
    "select": [
        {"function": "min", "var": "SpreadPnLPM", "name": "MinSpread"},
        {"function": "max", "var": "SpreadPnLPM", "name": "MaxSpread"},
        {"function": "count", "var": "Symbol", "name": "Count"},
        {"function": "sum", "var": "TradeQuantityUSD", "name": "TotalVolume"}
    ],
    "filter": [
        {"function": "within", "var": "Date", "pars": ["2014-01-01", "2021-11-30"]}
    ]
}

# this is api end-point which returns execution stats
endpoint = "v1/fx/algo/execution-stats"

## call the API
response = tf_api_object.query_api(endpoint, options)

## translate API result into pandas dataframe
data_frame = pd.DataFrame(response["result"])
# data_frame = data_frame.set_index("LP")
data_frame
```
```
#### Results

![api_algo_execution_stats_ex14.png](assets/images/api_algo/execution_stats/api_algo_execution_stats_ex14.png)

### Percentile 

`percentile` returns the x percentile of the specified column.

We return the value corresponding to the 25th, 50th, 75th,90th and 100th percentile of `SpreadPnLPM`.
You can query various percentiles in the `select` parameter and analyse distribution of the chosen metric.

```python
```
## tradefeedr library
from tradefeedr_public_content.v1.generic.tradefeedr_api import TradefeedrApi

## need pandas to translate JSON results from API
import pandas as pd

## create API object
tf_api_object = TradefeedrApi(demo=True)

## options
options = {
    "groupby": [
        "LP"
    ],
    "select": [
        "TradeQuantityUSD", # sum
        "SpreadPnLPM",      # TradeQuantityUSD-weighted average
        "DecayPM1s",        # TradeQuantityUSD-weighted average
        {"name": "SpreadPnLPM_Pct25", "function": "percentile", "var": "SpreadPnLPM", "par": 25},
        {"name": "SpreadPnLPM_Pct50", "function": "percentile", "var": "SpreadPnLPM", "par": 50},
        {"name": "SpreadPnLPM_Pct75", "function": "percentile", "var": "SpreadPnLPM", "par": 75},
        {"name": "SpreadPnLPM_Pct90", "function": "percentile", "var": "SpreadPnLPM", "par": 90},
        {"name": "SpreadPnLPM_Pct100", "function": "percentile", "var": "SpreadPnLPM", "par": 100}
    ],
    "filter": [
        {"function": "within", "var": "Date", "pars": ["2014-01-01", "2021-11-30"]},
        {"function": "within", "var": "TradeTime", "transform": "time", "pars": ["12:00:00", "14:00:00"]}
    ]
}

# this is api end-point which returns execution stats
endpoint = "v1/fx/algo/execution-stats"

## call the API
response = tf_api_object.query_api(endpoint, options)

## translate API result into pandas dataframe
data_frame = pd.DataFrame(response["result"])
# data_frame = data_frame.set_index("LP")
data_frame
```
```
#### Results

![api_algo_execution_stats_ex15.png](assets/images/api_algo/execution_stats/api_algo_execution_stats_ex15.png)

#### Figure

```python
```
# import plotly libary
import plotly.express as px

# Modify dataframe
data_frame = data_frame.set_index("LP")

# Plot figure
fig = px.bar(data_frame, y=["SpreadPnLPM_Pct25", "SpreadPnLPM_Pct50",
                            "SpreadPnLPM_Pct75", "SpreadPnLPM_Pct90", "SpreadPnLPM_Pct100"],
             barmode="group", title="SpreadPnLPM Percentiles by LP")
fig.show()
```
```
### Rank Percentile 

The `rank_percentile` function transforms the target column into a value in the range of [0;100].

This is applied in the `filter` option. The algo user can use this function to apply an outlier filtering. 
`DecayPM1s` results are filtered to only select values which fall within the 10th-90th percentile range.

```python
```
## tradefeedr library
from tradefeedr_public_content.v1.generic.tradefeedr_api import TradefeedrApi

## need pandas to translate JSON results from API
import pandas as pd

## create API object
tf_api_object = TradefeedrApi(demo=True)

## options
options = {
    "groupby": [
        "LP"
    ],
    "select": [
        "TradeQuantityUSD", # sum
        "SpreadPnLPM",      # TradeQuantityUSD-weighted average
        "DecayPM1s"        # TradeQuantityUSD-weighted average
    ],
    "filter": [
        {"function": "within", "var": "Date", "pars": ["2014-01-01", "2021-11-30"]},
        {"function": "within", "var": "TradeTime", "transform": "time", "pars": ["12:00:00", "14:00:00"]},
        {"function": "within", "var": "DecayPM1s", "transform": "rank_percentile", "pars": [10, 90]}
    ]
}

# this is api end-point which returns execution stats
endpoint = "v1/fx/algo/execution-stats"

## call the API
response = tf_api_object.query_api(endpoint, options)

## translate API result into pandas dataframe
data_frame = pd.DataFrame(response["result"])
# data_frame = data_frame.set_index("LP")
data_frame
```
```
#### Results

![api_algo_execution_stats_ex16.png](assets/images/api_algo/execution_stats/api_algo_execution_stats_ex16.png)

### Stale market data (minus transformation)

Applying the `minus` transformation to compute the difference between `TradeTime` and `ArrivalTime`, this measures how stale the data is.
This example filters the data to only include results where the difference between `TradeTime` and `ArrivalTime` is less than 500ns.
Use `diff_millis` instead of `minus` to get time difference in ms.

```python
```
## tradefeedr library
from tradefeedr_public_content.v1.generic.tradefeedr_api import TradefeedrApi

## need pandas to translate JSON results from API
import pandas as pd

## create API object
tf_api_object = TradefeedrApi(demo=True)

## options
options = {
    "groupby": [
        "LP"
    ],
    "select": [
        "TradeQuantityUSD", # sum
        "SpreadPnLPM",      # TradeQuantityUSD-weighted average
        "DecayPM1s"         # TradeQuantityUSD-weighted average
    ],
    "filter": [
        {"function": "within", "var": "Date", "pars": ["2014-01-01", "2021-11-30"]},
        {"function": "within", "var": "TradeTime", "transform": "time", "pars": ["12:00:00", "14:00:00"]},
        {"function": "within", "var": ["TradeTime", "ArrivalTime"], "transform": "minus", "pars": [0, 500]}
    ]
}

# this is api end-point which returns execution stats
endpoint = "v1/fx/algo/execution-stats"

## call the API
response = tf_api_object.query_api(endpoint, options)

## translate API result into pandas dataframe
data_frame = pd.DataFrame(response["result"])
# data_frame = data_frame.set_index("LP")
data_frame
```
```
#### Results

![api_algo_execution_stats_ex17.png](assets/images/api_algo/execution_stats/api_algo_execution_stats_ex17.png)]

## Field Definitions

Refer to [Analytics Algo](../analytics/algo.md) page for details and formula.

```csv
Name,Description
ParentChild,"Equal to either ""Parent"" or ""Child""  and determines whether the rows is ""Parent"" or ""Child"" row. ""Parent” rows are the events generated by an AlgoUser (for example Algo Submitted, Limit Price changed, OrderQuantity change). ""Child"" rows reflect the actions of AlgoVendor, the institution responsible for algo execution. Those include child fills, order placements and rejects. At the minimum the child fills are provided "
Date,Date corresponding to TradeTime
TradeTime,TradeTime - Time (GMT) when the trade was filled
ArrivalTime,"For ""Parent” rows it is the time when algo user-event (order submitted, Quantity Changed, Limit Price changes) arrives. For ""Child” rows (for example Fill) ArrivalTime is the time when trade request was sent. It is GMT time"
Symbol,Currency pair. For example EURUSD.
Side,"Trade side. ""B” for buy and ""S” for sell."
Price,Execution Price for child fills.
TradeID,"Unique identifier for a trading event. Event can fill, order submission, reject or other event related to trading workflow"
ParentOrderID,ParentOrderID for each algo run. Globally unique to each submitting LP
OrderID,OrderID within specific ParentOrderID.
SubParentOrderID,"Identifies changes in algo execution regime as submitted by AlgoVendor to reflect the business logic. For example every time AlgoUrgency is changed, subParentOrderID can be changed. Then algo performance can be aggregated for different algo setting separately (grouping by ParentOrderID and subParentOrderID)"
TradeQuantity,Traded quantity expressed in TradeCurrency
OrderQuantity,"For ""Parent” rows it the amount of TradeCurrency that is actually required by the algo user.  For ""Child” rows it the amount requested by AlgoVendor from underlying LP"
TradeCurrency,Denomination Currency for TradeQuantity and OrderQuantity. For example EUR.
ExecVenue,"Execution Venue where the execution is taking place. For ""Parent"" rows it is channel name through which the algo order was submitted. For example: ""BankGUI"" or ""FXAll"" or ""Bloomberg"".  It is how the user connects to the underlying AlgoVendor. For ""Child"" order it is where the order was placed  or filled. For example ""Reuters"" or ""EBS"" if the order is place on those venues"
LP,"Executing LP - counterparty to the trade. For Parent rows it is the AlgoVendor, the institution responsible for specific ParentOrderID. For Child rows it is the actual LP (selected by AlgoVendor and can be AlgoVendor themselves) doing the child execution."
AlgoVendor,"Algo Vendor, Provider of the Algo. Unique for ParentOrderID. Same for Parent and Child rows."
LPstream,"Pricing Stream of Executing LP. For example ""No-Last-look”"
LiqPool,"Pool executing LP belongs to. Typically, liquidity pool is a group of LP aggregated according to some common logic by the end user."
QuoteTime,The time of the quote as labelled by executing LP. Quote time should generally be before the Arrival Time.
AlgoName,Name of the Algo.
OrderStatus,"For ""Child” rows it can be ""F"" for fills and ""R"" for Rejects. It can also be ""S"" for ""submitted” or ""C"" for ""cancelled” – in case AlgoVendor is willing to provide order placement information. For ""Parent” rows it is anything else which would make business sense for a client - for example AlgoStart, AlgoEnd, AlgoCancelled etc."
OrderType,For Child rows and fills it is normally Passive/Active/Mid or Limit/Market classification. The exact terminology is subject to AlgoVendor
OrderTTL,"Normally for ""Child” rows. FOK (Fill or Kill), AON, IOC, GTC, GTD"
LimitPrice,"For ""Parent” rows it the limit price as instructed by AlgoUser. Multiple ""parent” rows when Limit Price is changed. ArrivalTime indicates when the user submits the LimitPrice instructions (see ArrivalTime description). For ""Child” rows it is the whatever is the LimitPrice submitted by AlgoVendor while trading on an ECN"
Account,Name of the underlying client this ParentOrderID executed on behalf of
SubAccount,SubAccount associated with this ParentOrderID
TradeReason,"Any descriptive Trade Reason. Stop, Internal, External, RiskOverflow etc. User specific"
Trader,The name of  a trader associated with this ParentOrderID
AlgoUrgency,"AlgoUrgency. Provider defined parameters. For example: ""Medium"", ""High"" or ""Low"""
AlgoStrategy,"Additional Name for the AlgoName. Name of the strategy.  For example AlgoName can be ""TWAP"" and Strategy is ""Passive"""
ExchTradeID,"Exchange trade id  if execution is on one of the ECNs. Effectively it is an ID that ""ExecVenue"" would understand"
AlgoParams,"JSON file with any additional information about algo performance which cannot be described by any combination AlgoName, AlgoStrategy and AlgoUrgency"
NetPrice,"Price received by the client after Algo execution fees. Should be above ""Price"" for buy trades and below ""Price ""for sell trades."
ExecLoc,"Possible values include London,NewYork,Paris,Tokyo,Singapore. Geographical location where execution is taking place. Applied to location of the matching engine (can do LD4) or bank trading desk "
PrincipalMid,Fair mid-price for Symbol according Algo Vendor. It is provided by AlgoVendor and is understood as mid-price they would use to calculate algo performance
RiskTransferPrice,Fair risk transfer price according to AlgoVendor. It is provided by AlgoVendor and is understood as risk transfer price they would use to calculate algo performance.
ValueDate,Value date  for the trade
Product,"FXSPOT, FXNDF, FXFORWARD, FXSWAP"
SpotRate,"Agreed SpotRate for FXNDF, FXFORWARD,FXSWAP"
SideOriginal,Original Side submitted by AlgoVendor. This is mainly used for reconciliation purposes if AlgoVendor uses different notation internally.
PrimaryBid,For each fill or any event where you see PrimaryVenue bid correspond to the time of this event (TradeTime)
PrimaryAsk,For each fill or any other event where you see PrimaryVenue ask  correspond to the time of this event (TradeTime)
Platform,"Bloomberg, FXAll (Refinitiv). Should be same across Parent and Child orders "
PlatformOrderID,OrderID which is understood by the platform (see Platform Field)
TradeQuantityBase,TradeQuantity in the base currency of the Symbol
Midneg10s,Tradefeedr mid price 10s before the trade
Midneg5s,Tradefeedr mid price 5s before the trade
Midneg4s,Tradefeedr mid price 4s before the trade
Midneg3s,Tradefeedr mid price 3s before the trade
Midneg2s,Tradefeedr mid price 2s before the trade
Midneg1s,Tradefeedr mid price 1s before the trade
Midneg500ms,Tradefeedr mid price 500s before the trade
Midneg250ms,Tradefeedr mid price 250s before the trade
Midneg100ms,Tradefeedr mid price 100s before the trade
Mid0,Tradefeedr mid price at the time immediately preceding the TradeTime
Mid50ms,Tradefeedr mid price 50ms after the TradeTime
Mid100ms,Tradefeedr mid price 100ms after the TradeTime
Mid250ms,Tradefeedr mid price 250ms after the TradeTime
Mid500ms,Tradefeedr mid price 500ms after the TradeTime
Mid1s,Tradefeedr mid price 1s after the TradeTime
Mid2s,Tradefeedr mid price 2s after the TradeTime
Mid3s,Tradefeedr mid price 3s after the TradeTime
Mid4s,Tradefeedr mid price 4s after the TradeTime
Mid5s,Tradefeedr mid price 5s after the TradeTime
Mid10s,Tradefeedr mid price 10s after the TradeTime
Mid15s,Tradefeedr mid price 15s after the TradeTime
Mid20s,Tradefeedr mid price 20s after the TradeTime
Mid30s,Tradefeedr mid price 30s after the TradeTime
Mid45s,Tradefeedr mid price 45s after the TradeTime
Mid1m,Tradefeedr mid price 1m after the TradeTime
Mid2m,Tradefeedr mid price 2m after the TradeTime
Mid3m,Tradefeedr mid price 3m after the TradeTime
Mid4m,Tradefeedr mid price 4m after the TradeTime
Mid5m,Tradefeedr mid price 5m after the TradeTime
Mid10m,Tradefeedr mid price 10m after the TradeTime
DecayPMneg10s,Change in Tradefeedr mid price in $/m 10s  before the TradeTime
DecayPMneg5s,Change in Tradefeedr mid price in $/m 5s  before the TradeTime
DecayPMneg4s,Change in Tradefeedr mid price in $/m 4s  before the TradeTime
DecayPMneg3s,Change in Tradefeedr mid price in $/m 3s  before the TradeTime
DecayPMneg2s,Change in Tradefeedr mid price in $/m 2s  before the TradeTime
DecayPMneg1s,Change in Tradefeedr mid price in $/m1s  before the TradeTime
DecayPMneg500ms,Change in Tradefeedr mid price in $/m 500ms  before the TradeTime
DecayPMneg250ms,Change in Tradefeedr mid price in $/m 250ms  before the TradeTime
DecayPMneg100ms,Change in Tradefeedr mid price in $/m 100ms  before the TradeTime
DecayPM0,Always zero
DecayPM50ms,Change in Tradefeedr mid price in $/m 50ms  after the TradeTime
DecayPM100ms,Change in Tradefeedr mid price in $/m 100ms  after the TradeTime
DecayPM250ms,Change in Tradefeedr mid price in $/m 250ms  after the TradeTime
DecayPM500ms,Change in Tradefeedr mid price in $/m 500ms  after the TradeTime
DecayPM1s,Change in Tradefeedr mid price in $/m 1s  after the TradeTime
DecayPM2s,Change in Tradefeedr mid price in $/m 2s  after the TradeTime
DecayPM3s,Change in Tradefeedr mid price in $/m 3s  after the TradeTime
DecayPM4s,Change in Tradefeedr mid price in $/m 4s  after the TradeTime
DecayPM5s,Change in Tradefeedr mid price in $/m 5s  after the TradeTime
DecayPM10s,Change in Tradefeedr mid price in $/m 10s  after the TradeTime
DecayPM15s,Change in Tradefeedr mid price in $/m 15s  after the TradeTime
DecayPM20s,Change in Tradefeedr mid price in $/m 20s  after the TradeTime
DecayPM30s,Change in Tradefeedr mid price in $/m 30s  after the TradeTime
DecayPM45s,Change in Tradefeedr mid price in $/m 45s  after the TradeTime
DecayPM1m,Change in Tradefeedr mid price in $/m 1m  after the TradeTime
DecayPM2m,Change in Tradefeedr mid price in $/m 2m  after the TradeTime
DecayPM3m,Change in Tradefeedr mid price in $/m 3m  after the TradeTime
DecayPM4m,Change in Tradefeedr mid price in $/m 4m  after the TradeTime
DecayPM5m,Change in Tradefeedr mid price in $/m 5m  after the TradeTime
DecayPM10m,Change in Tradefeedr mid price in $/m 10m  after the TradeTime
TradeQuantityUSD,USD Equivalent of TradeQuantity
SpreadPnL,Spread Paid in Child Order in USD
SpreadPnLPM,Spread Paid in Child Order in $/million traded
OrderQuantityUSD,USD Equivalent of OrderQuantity
ArrivalPrice,Tradefeedr mid-price at the time immediately preceding Arrival Time
LatencyMillis,TradeTime minus ArrivalTime expressed in milliseconds
OrderExecutionScore,"Individual child order Execution Score - percentile rank of order execution Price againt mid-price distribution during algo execution.  For example, buy at the low of range would get a rank of 100 and buy at the high the price range would get a rank of 0. Reverse for sell order."
OrderReversalScore,Individual child order ReversalScore. It is rank-percentile of order execution Prices against mid-price distribution post algo execution. 
TwapExecution,Twap for the time algo was active in the market
TwapReversal,Twap for the reversal time algo post algo execution (half of execution time)
EventTime,EventTime is equal to TradeTime for Child rows and ArrivalTime for Parent rows.  EventTime is used to display/arrange all child and parent events in chronological order from the algo user perspective - when fills are done (child rows) and when new user instructions are submitted (parent rows).
```

### Aggreggation Functions (for `select` if `groupby` is present)

```csv
Function,Description,Example
sum,sum,"{""function"":""sum"",""var"":""TradeQuantityUSD"",""name"":""TotalVolume""},"
avg,average,"{""function"":""avg"",""var"":""TradeQuantityUSD"",""name"":""AvgTradeSize""}"
dev,standard deviation,"{""function"":""dev"",""var"":""TradeQuantityUSD"",""name"":""DevTotalSize""},"
max,maximum,"{""function"":""max"",""var"":""TradeQuantityUSD"",""name"":""MaxTradeSize""},"
min,minimum,"{""function"":""min"",""var"":""TradeQuantityUSD"",""name"":""MinTradeSize""},"
count,count,"{""function"":""count"",""var"":""TradeQuantityUSD"",""name"":""NumberOfTrades""},"
first,first observation,"{""function"":""first"",""var"":""TradeTime"",""name"":""FirstTime""}"
last,last observation,"{""function"":""last"", ""var"":""TradeTime"",""name"":""LastTime""}"
percentile,returns the x percentile of the specified column,"{""function"": ""percentile"", ""var"": ""SpreadPnLPM"", ""par"": 90}"
```

### Modification Functions (for `filter` and `groupby` )

```csv
Function,Description,Example
eqx,"applied to sting variables,returns the value of parament if variable is equal to parameter and “Other” otherwise","{""function"":""eqx"",""par"":""LP1"",""var"":""LP""}"
bar,"rounds the variable down to the nearest multiple of the parameter, used to group to generate equal spaced buckets","{""function"":""bar"",""par"":""10"",""transform"":""minute"",""var"":""TradeTime""}"
minute,take the minute component from the variable,"{""function"":""bar"",""par"":""10"",""transform"":""minute"",""var"":""TradeTime""}"
in,"returns True if the variable is in the List and False otherwise, mainly for filters","{""function"":""in"",""var"":""Symbol"",""pars"":[""EURUSD"",""USDJPY""]},"
within,"within, variable within a provided range","{""function"":""within"",""var"":""date"",""pars"":[""2014-01-01"",""2021-11-30""]},"
gt,return True if the variable is greater than its parameter and False otherwise,"{""function"":""gt"",""var"":""TradeQuantityUSD"",""par"":1000000}, # greater than"
lt,return True if the variable is less than its paramer and False otherwise,"{""function"":""lt"",""var"":""SpreadPnLPM"",""par"":300}, # less than"
eq,returns True is the variable is equal to function parameter and false otherwise,"{""function"":""eq"",""var"":""Symbol"",""par"":""EURUSD""}"
hist,"split the variable into categories with N equally spaced buckets, typically used in group-by to produce histograms, function returns middle value of the bucket","{""function"":""hist"",""var"":""SpreadPnLPM"",""par"":""10""}"
hist_label,"split the variable into categories with N equally spaced buckets, function returns the bucket with the bucket number","{""function"":""hist_label"",""var"":""SpreadPnLPM"",""par"":""10""}"
hist_range,"split the variable into categories with N equally spaced buckets, function returns the range of the bucket","{""function"":""hist_range"",""var"":""SpreadPnLPM"",""par"":""10""}"
hist_index,"split the variable into categories with N equally spaced buckets, function returns the index of the bucket","{""function"":""hist_index"",""var"":""SpreadPnLPM"",""par"":""10""}"
like,matches string based on wild card pattern,"{""function"":""like"",""var"":""Symbol"",""pars"":""*USD""}"
not_eq,not equal. To exclude variables,"{""function"":""not_eq"",""var"":""Symbol"",""par"":""EURUSD""}"
not_in,"not in. returns False if the variable is in the List and True otherwise, mainly for filters","{""function"":""not_in"",""var"":""Symbol"",""pars"":[""EURUSD"",""USDJPY""]}"
rank_percentile,function transforms the target column into a value in the range of [0;100],"{""function"": ""within"", ""var"": ""DecayPM1s"", ""transform"": ""rank_percentile"", ""pars"": [10, 90]}"
within_percentile,function filters the dataset to within target percentile range of the target column,"{""function"": ""within_percentile"", ""var"": ""DecayPM1s"", ""pars"": [10, 90]}"
diff_millis,"function takes two time columns x,y and performs an subtraction x-y results are in milliseconds","{""function"": ""within"", ""var"": [""TradeTime"", ""ArrivalTime""], ""transform"": ""diff_millis"", ""pars"": [0, 500]}"
diff_nanos,"function takes two time columns x,y and performs an subtraction x-y results are in nanoseconds","{""function"": ""within"", ""var"": [""TradeTime"", ""ArrivalTime""], ""transform"": ""diff_nanos"", ""pars"": [0, 500]}"
minus,"function takes two columns x,y and performs an subtraction x-y.","{""function"": ""within"", ""var"": [""OrderExecutionScore"", ""OrderReversalScore""], ""transform"": ""minus"", ""pars"": [0, 500]}"
plus,"function takes two columns x,y and performs an additon x+y.","{""function"": ""within"", ""var"": [""OrderExecutionScore"", ""OrderReversalScore""], ""transform"": ""plus"", ""pars"": [80, 150]}"
```